<!DOCTYPE html>
<html>
	<head>
    	<script type="text/javascript" src="d3.min.js"></script>
    	<style type="text/css">
    	.axis path,
		.axis line {
		    fill: none;
		    stroke: white;
		    shape-rendering: crispEdges;
		}
		.axis text {
		    font-size: 12px;
		}

		.yAxes path,
		.yAxes line {
		    fill: none;
		    stroke: black;
		    shape-rendering: crispEdges;
		}
		.yAxes text {
		    font-size: 11px;
		}

		.title {
    		font: 300 32px Helvetica Neue;
    		fill: #222;
    		font-weight: bold;
		}
		</style>
  	</head>
  	<body>
    	<script>
    	var barWidth = 35;
    	var barPadding = 5;
    	var pieWidth = 500;
    	var piePadding = 35;
    	var year = 0;


    	var bodySelection = d3.select("body");

 		var svgSelection = bodySelection.append("svg")
 		.attr("width", pieWidth+35)
 		.attr("height", 500);

    	//Create the Scale we will use for the Axis
 		var xScale = d3.time.scale()
 		.domain([new Date(2012, 0, 1), new Date(2012, 11, 31)])
 		.range([0, pieWidth]);

		//Create the Axis
		var xAxis = d3.svg.axis() .ticks(d3.time.months)
		.tickSize(16, 0)
		.tickFormat(d3.time.format("%b"))
                  .scale(xScale);

 		svgSelection.append("g").attr("class", "axis").attr("transform", "translate("+ ((barWidth/2)+barPadding+piePadding) +"," + (385) + ")").call(xAxis);

 		


 		//Load the data
 		d3.csv("meteo.csv", function(error, data) {
	 		var nest = d3.nest()
		    .key(function(d) { return d.year; })
		    .key(function(d) { return d.month; })
		    .entries(data);

		    nest.forEach(function(year) {
		    	year.values.forEach(function(month) {
		    		sum = 0;
		    		month.values.forEach(function(day) {
		    			sum += parseInt(day.temperature)/10;
		    		});
		    		month.mean = sum/month.values.length;
		    	});
		    });


		    // A label for the current year.
			var title = svgSelection.append("text")
			    .attr("class", "title")
			    .attr("dy", ".71em")
			    .attr("transform", "translate(50,10)")
			    .text(nest[year].key);
	 		
			//Create the Scale we will use for the Axis
	 		var yScale = d3.scale.linear()
                     .domain([0, d3.max(nest[year].values, function(month,j) { return month.mean; })])
                     .range([400, 0]);

	 		//Create the Axis
			var yAxis = d3.svg.axis().orient("left").ticks(5)
        		.scale(yScale);
        	svgSelection.append("g").attr("class", "yAxes").attr("transform", "translate("+ piePadding +"," + 0 + ")").call(yAxis);


	 		var rect = svgSelection.append("g").attr("transform", "translate("+ piePadding +"," + 0 + ")").selectAll("rect")
		 		.data(nest[year].values)
		 		.enter()
		 		.append("rect");

		 		rect.attr("x", function (d, i) { return xScale(new Date(2012, i, 1))+barPadding; })
		 		.attr("y", function (d) { return yScale(d.mean); })
		 		.attr("height", function (d) { return 400-yScale(d.mean); })
		 		.attr("width", function (d) { return barWidth; })
		 		.style("fill", function(d) { return "rgb(238,148,40)"; });


	 		var text = svgSelection.append("g").attr("transform", "translate("+ piePadding +"," + 0 + ")").selectAll("text")
			   .data(nest[year].values)
			   .enter()
			   .append("text");

			   text.text(function(d, i) {
			   		return d.mean.toFixed(1);
			   })
			   .attr("text-anchor", "middle")
			   .attr("x", function(d, i) {
			   		return xScale(new Date(2012, i, 1))+barPadding+(barWidth/2);
			   })
			   .attr("y", function(d) {
			   		return yScale(d.mean)+18;
			   })
			   .attr("font-family", "sans-serif")
			   .attr("font-size", "12px")
			   .attr("fill", "black")
			   .attr("class", "label");


			// Allow the arrow keys to change the displayed year.
			window.focus();
			d3.select(window).on("keydown", function() {
				switch (d3.event.keyCode) {
					case 39: year = (year+1)%(nest.length); break;
					case 37: year = year-1; break;
				}
				if(year<0)
					year = nest.length-1;

				update();
			});


			//Function to update the data with the arrows
			function update() {
				title.text(nest[year].key);


				yScale = d3.scale.linear()
                    .domain([0, d3.max(nest[year].values, function(month,j) { return month.mean; })])
                    .range([400, 0]);

                //Create the Axis
				var yAxis = d3.svg.axis().orient("left").ticks(5)
	        		.scale(yScale);
	        	svgSelection.select(".yAxes")
					.transition()
					.duration(1000).call(yAxis);

				var rect = svgSelection.selectAll("rect").data(nest[year].values)
					.transition()
					.duration(1000);

			   	rect.attr("y", function (d) {  return yScale(d.mean); })
	 				.attr("height", function (d) { return 400-yScale(d.mean); });

	 			var text = svgSelection.selectAll(".label")
				   	.data(nest[year].values)
					.transition()
					.duration(1000);

				text.text(function(d, i) { return d.mean.toFixed(1); })
					.attr("x", function(d, i) {
				   		return xScale(new Date(2012, i, 1))+barPadding+(barWidth/2);
				   	})
				   .attr("y", function(d) {
				   		return Math.min(yScale(d.mean), 382)+18;
				   });
				
			}
		});
 		


 		

    	</script>
  	</body>
</html>